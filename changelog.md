changed some logic trying to prevent some possible concurrency issues